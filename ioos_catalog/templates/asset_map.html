{% extends "layout.html" %}

{% block css %}
<link rel=stylesheet type=text/css href="{{ url_for('.static', filename='css/map-style.css') }}"></link>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
{% endblock %}

{% block basepage %}

<button id="sidebar-toggle" class="btn btn-default">
  <span class="glyphicon glyphicon-align-justify"></span>
</button>

<div id="branding">
  <a href="/">
    <img src="{{ url_for('.static', filename='img/ioos-white.gif')}}" alt="IOOS" />
  </a>
</div>

<div id="map_infobar">
  <button type="button" class="btn btn-lg pull-right close">&times;</button>
  <button id="show_geo" class="btn btn-lg btn-primary">
    <span class="glyphicon glyphicon-search"></span>
  </button>
  <h4 id="name"></h4>
  <p id="description"></p>

  <h5>Service Endpoint</h5>

  <div class="btn-group pull-right">
    <button class="btn btn-default">
      <span class="label label-info" id="service_type"></span>
    </button>
    <button class="btn btn-default">
      <span class="glyphicon glyphicon-ok-circle"></span>
    </button>
    <a href="#" id="service_link" target="_blank" class="btn btn-info">
      <span class="glyphicon glyphicon-new-window"></span>
    </a>
  </div>

  <dl>
    <dt>Name</dt>
    <dd id="service_name"></dd>
    <dt>Last Pinged</dt>
    <dd id="service_last_ping_time"></dd>
  </dl>



  <h5>Dataset Info</h5>


  <a href="#" id="dataset_link" target="_blank" class="btn btn-info">
    <span class="glyphicon glyphicon-new-window"></span>
    Dataset
  </a>

  <dl>
    <dt>Asset Type</dt>
    <dd id="asset_type" class="list-unstyled"></dd>
    <dt>Variables</dt>
    <dd>
      <ul id="variables" class="list-unstyled"></ul>
    </dd>

    <dt>Keywords</dt>
    <dd>
      <ul id="keywords"></ul>
    </dd>

  </dl>
</div>

<div id="map_sidebar">

  <div id="filters">
    <select name="filter-provider" class="form-control">
      <option value="null">-</option>
      {% for region in regions %}
      <option>{{ region }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="btn-group pull-right" data-toggle="buttons">
    <label class="btn btn-default btn-xs active">
      <input type="radio" name="viewopts" value="list">
        <span class="glyphicon glyphicon-th-list"></span>
      </input>
    </label>

    <label class="btn btn-default btn-xs">
      <input type="radio" name="viewopts" value="thumbs">
        <span class="glyphicon glyphicon-th-large"></span>
      </input>
    </label>

  </div>

  <hr />


  <!--<ul class="media-list" id="thumbnails"></ul>-->
  <div id="thumbnails">

  </div>
</div>

<!--<svg id="map" preserveAspectRatio="xMidYMid"></svg>-->
<!--<svg id="map" viewBox="0 0 1500 1500" preserveAspectRatio="xMinYMin slice"></svg>-->

<div id="map"></div>

<svg id="shared"></svg>


<script type="text/javascript" src="{{ url_for('.static', filename='js/d3.v3.min.js') }}" /></script>
<script type="text/javascript" src="{{ url_for('.static', filename='js/queue.v1.min.js') }}" /></script>
<script type="text/javascript" src="{{ url_for('.static', filename='js/d3.geo.projection.v0.min.js') }}" /></script>
<script type="text/javascript" src="{{ url_for('.static', filename='js/d3.geo.zoom.js') }}" /></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>

<script type="text/javascript">

function toggleInfo(did, sindex) {

  /*
  if ($('#map_infobar').css('left') != '0px') {
    $('#map_sidebar').animate({
      'left': '+=250'
    }, 150);
    $('#map_infobar').animate({
      'left': '-=50'
    }, 150);

    $('#map_infobar dl').empty();

    return;
  }

  $('#map_sidebar').animate({
    'left': '-=250'
  }, 150, function() {});

  $('#map_infobar').animate({
    'left': '+=50'
  }, 150, function() {});
  */
  $.getJSON('/map/details/'+did +'/'+sindex, function(data) {
    var ib = $('#map_infobar');

    ib.show();

    $('#name', ib).text(data.name);
    $('#description', ib).text(data.description);

    // links
    $('#dataset_link', ib).attr('href', data.dataset_link);
    $('#service_link', ib).attr('href', data.service_link);

    // service
    $('#service_name', ib).text(data.service_name);
    $('#service_last_ping_time', ib).text(data.service_last_ping_time);
    $('#service_type', ib).text(data.service_type);

    // general dl
    $('#asset_type', ib).text(data.asset_type);

    // lists
    var variables = d3.select('#map_infobar').select('#variables').selectAll('li')
      .data(data.variables);

    variables.exit().remove();
    variables.enter()
      .append('li')
      .text(function(d) { return d; });

    var keywords = d3.select('#map_infobar').select('#keywords').selectAll('li')
      .data(data.keywords);

    keywords.exit().remove();
    keywords.enter()
      .append('li')
      .text(function(d) { return d; });

  });
}

function setupFilters() {
  $('select[name^="filter"]').change(function() {
    var provVal = $('select[name="filter-provider"]').val();
    if (provVal == "null") {
      //window.location = "{{ url_for("asset_map") }}";
      console.log("michael jackson's beat it");
      return;
    }
    var url = '/map/geojson/';
    url += provVal + "/";

    d3.json(url, addData);
  })
}


setupFilters();

var map = L.map('map').setView([44, -100], 4);

//var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var baseUrl='http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}.jpg';
//var baseAttrib='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
var base = new L.TileLayer(baseUrl, {minZoom: 1, maxZoom: 12, /*attribution: baseAttrib*/}); 

map.addLayer(base);

/* add hook layers for d3 involvement */
var svg = d3.select(map.getPanes().overlayPane).append('svg'),
      g = svg.append('g').attr('class', 'leaflet-zoom-hide');

// adapter code for leaflet from http://bost.ocks.org/mike/leaflet/
function projectPoint(x, y) {
  var point = map.latLngToLayerPoint(new L.LatLng(y, x));
  this.stream.point(point.x, point.y);
}

var transform = d3.geo.transform({point:projectPoint}),
         path = d3.geo.path().projection(transform);

var datapaths = null,
  features = null;

function reset() {
  // fixup group to correct size
  if (!features) { return; }

  var      bounds = path.bounds(features),
          topLeft = bounds[0],
      bottomRight = bounds[1];

  svg
    .attr('width', bottomRight[0] - topLeft[0])
    .attr('height', bottomRight[1] - topLeft[1])
    .style('left', topLeft[0] + 'px')
    .style('top', topLeft[1] + 'px')
    ;

  g.attr('transform', 'translate(' + -topLeft[0] + ',' + -topLeft[1] + ')');

  // do paths
  datapaths.attr('d', path);
}

map.on('viewreset', reset);

function addData(error, geojson) {

  //L.geoJson(geojson).addTo(map);

  features = geojson;

  // on main map
  datapaths = g.selectAll('.dataset')
    .data(geojson.features, function(d) { return d.properties.id;});

  datapaths.exit().remove();

  datapaths.enter()
    .append('path')
      .attr('id', function(d) { return d.properties.id; })
      .attr('class', 'ioos-dataset')

  datapaths.classed('dataset', function(d) { return d.geometry.type != 'LineString'; });
  datapaths.classed('dataset-trajectory', function(d) { return d.geometry.type == 'LineString'; });

  reset();

  // on thumbnail index
  var thumbs = d3.select('#thumbnails').selectAll('.media')
    .data(geojson.features, function(d) { return d.properties.id; });

  thumbs.exit().remove();

  var ps = thumbs.enter()
    .append('div')
      .attr('class', 'media');

  if ($('input[name="viewopts"]:checked').val() == 'thumbs') {
    ps.classed({'media-grid':true});
  }

    var thumbs = ps.append('a')
      .attr('class', 'pull-right')
      .attr('href', '#')
      .append('svg')
      .attr('class', 'media-object')
      .attr('viewBox', '0 0 64 64')
      /*
      .attr('width', '100%')
      .attr('height', '100%');
     */
      ;

    thumbs.append('use')
      .attr('xlink:href', '#basegeo');

    thumbs.append('path')
      .attr('id', function(d) { return 'thumb_' + d.properties.id })
      .attr('class', 'dataset active')
      ;

    //thumbs.attr('viewBox', '0 0 800 700');
    //thumbs.attr('preserveAspectRatio', 'xMidYMid slice');

    var body = ps.append('div')
      .attr('class', 'media-body');

    body
      .append('h4')
      .attr('class', 'media-heading')
      .text(function(d) { return d.properties.name || d.properties.id; });

    body
      .append('p')
      .text(function(d) { return d.properties.description || ""; });

    ps.on('mouseout', function(d) {
      d3.selectAll('#map path.active').classed({'active':false});
      d3.select(this).classed({'list-group-item-info': false});
    });

    ps.on('mouseover', function(d) {
      var sel = $('#map #' + d.properties.id);
      d3.selectAll(sel).classed({'active':true});

      d3.select(this).classed({'list-group-item-info': true});
    });

    ps.on('click', function(d) {
      var sel = $('#map .perm-active');
      d3.selectAll(sel).classed({'perm-active':false});

      var sel = $('#map #' + d.properties.id);
      d3.selectAll(sel).classed({'perm-active':true});

      $(this).siblings().removeClass('active');
      $(this).addClass('active');

      toggleInfo(d.properties.id, d.properties.sindex);
    });
}

/* standard controls */

$('#map_infobar .close').click(function() {
  $('#map_infobar').hide();
});

$('#sidebar-toggle').click(function() {
  var map = $('#map');
  if (map.css('left') == '0px') {
    $('#map_sidebar').show();
    $('#map_infobar').show();

    map.animate({
      'left': '30%',
      'width': '70%'
    }, 150);

  } else {
    $('#map_sidebar').hide();
    $('#map_infobar').hide();
    map.animate({
      'left': '0px',
      'width': '100%'
    }, 150);
  }
});

$('input[name="viewopts"]').on('change', function() {
  var val = $(this).val();

  if (val == "list") {
    $('#thumbnails .media').removeClass('media-grid');
  } else if (val == "thumbs") {
    $('#thumbnails .media').addClass('media-grid');
  }
});


/* debug */
$(function() {
  $('select').val('SECOORA', true).trigger('change');

});

</script>

{% endblock %}


