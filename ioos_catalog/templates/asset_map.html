{% extends "layout.html" %}

{% block css %}
<link rel=stylesheet type=text/css href="{{ url_for('.static', filename='css/map-style.css') }}"></link>
{% endblock %}

{% block basepage %}

<div id="map_infobar">
  <dl></dl>
</div>

<div id="map_sidebar">
  <div id="filters">
    <select name="filter-provider" class="form-control">
      <option value="null">-</option>
      {% for region in regions %}
      <option>{{ region }}</option>
      {% endfor %}
    </select>
  </div>

  <ul class="media-list" id="thumbnails"></ul>
</div>

<!--<svg id="map" preserveAspectRatio="xMidYMid"></svg>-->
<svg id="map" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid slice"></svg>

<svg id="shared"></svg>


<!--<script type="text/javascript" src="{{ url_for('.static', filename='js/d3.v3.min.js') }}" /></script>-->
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="{{ url_for('.static', filename='js/queue.v1.min.js') }}" /></script>
<script type="text/javascript" src="{{ url_for('.static', filename='js/d3.geo.projection.v0.min.js') }}" /></script>
<script type="text/javascript" src="{{ url_for('.static', filename='js/d3.geo.zoom.js') }}" /></script>

<script type="text/javascript">

function toggleInfo(did) {

  if ($('#map_infobar').css('left') != '0px') {
    $('#map_sidebar').animate({
      'left': '+=250'
    }, 150);
    $('#map_infobar').animate({
      'left': '-=50'
    }, 150);

    $('#map_infobar dl').empty();

    return;
  }

  $('#map_sidebar').animate({
    'left': '-=250'
  }, 150, function() {});

  $('#map_infobar').animate({
    'left': '+=50'
  }, 150, function() {});

  $.getJSON('/datasets/'+did + '/json', function(data) {
    var dl = $('#map_infobar dl');
    $.each(data, function(k, v) {
      dl.append('<dt>' + k + '</dt><dd>' + v + '</dd>');
    });
  });
}

function setupFilters() {
  $('select[name^="filter"]').change(function() {
    var provVal = $('select[name="filter-provider"]').val();
    if (provVal == "null") {
      //window.location = "{{ url_for("asset_map") }}";
      console.log("michael jackson's beat it");
      return;
    }
    var url = '/map/geojson/';
    url += provVal + "/";

    d3.json(url, addData);
  })
}


setupFilters();

var root = d3.select('#map');

// add points erry hundred
/*
for (var i = 0; i < 1000; i += 100) {

  for (var j = 0; j < 1000; j += 100) {
    root.append('circle')
      .attr('cx', i)
      .attr('cy', j)
      .attr('r', 3)
      .attr('fill', 'red');
  }
}
*/

var margin=10;

// @TODO: browser resize
var width = Math.max(960, window.innerWidth * 0.7),
    height = Math.max(500, window.innerHeight);

var projection = d3.geo.orthographic()
  .scale((1 << 12) / 2 / Math.PI)
  .translate([500, 500])
  .clipAngle(90)
  .rotate([100, -45])
  ;

var smallProjection = d3.geo.mercator()
  .scale(60)
  .translate([64, 64])
  .rotate([100, -50])
  ;

var center = projection([-100, 40])

/*
  .scale(950)
  .rotate([100, 0])
  .translate([750, 750])
  .center([0, 60])
  ;
  */

var graticule = d3.geo.graticule()
  .extent([[-180, 0], [0, 90]])
  .step([3, 3]);

var vector = root.append('path')
  .attr('id', 'geo');
  
var baseshare = d3.select('#shared')
  .append("defs")
  .append("path")
    .attr("id", "basegeo");

var path = d3.geo.path()
  .projection(projection);

var smallPath = d3.geo.path()
  .projection(smallProjection);

var zoom = d3.geo.zoom()
  .projection(projection)
  .on('zoom.redraw', function() {
    d3.event.sourceEvent.preventDefault();
    root.selectAll("path").attr("d", path);
    vector.attr("d", path);
  });

root.call(zoom);

  /*
var zoom = d3.behavior.zoom()
  .scale(projection.scale() * 2 * Math.PI)
  .scaleExtent([1 << 11, 1 << 14])
  .translate([width - center[0], height - center[1]])
  .on("zoom", zoomed);

function zoomed() {
  projection
    .scale(zoom.scale() / 2 / Math.PI)
    //.rotate(zoom.translate());
    .translate(zoom.translate());

  vector
    .attr("d", path);

  // adjust any features we've added
  root.selectAll('.dataset')
    .attr("d", path);
}
*/

d3.json("{{ url_for('.static', filename='geojson/ne_110m_land.geojson') }}", function (error, geojson) {
//d3.json("{{ url_for('.static', filename='geojson/ne_110m_admin_0_countries_lakes.geojson') }}", function (error, geojson) {
  //root.call(zoom);

  baseshare.datum(geojson)
    .attr('d', smallPath);

  root.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path);

  vector
    .datum(geojson)
    .attr('d', path);

  //zoomed();
});

function addData(error, geojson) {

  // on main map
  var svg = root.selectAll('.dataset')
    .data(geojson.features, function(d) { return d.properties.id;});

  svg.exit().remove();

  svg.enter()
    .append('path')
      .attr('id', function(d) { return d.properties.id; })
      .attr('class', 'dataset')//function(d) { return (d.properties.asset_type == 'CGRID' || d.properties.asset_type == 'RGRID' || d.properties.asset_type=='NCELL') ? 'dataset' : 'point'})
      .attr('d', path);

  // on thumbnail index
  var thumbs = d3.select('#thumbnails').selectAll('li')
    .data(geojson.features, function(d) { return d.properties.id; });

  thumbs.exit().remove();

  var ps = thumbs.enter()
    .append('li')
      .attr('class', 'media');

    var thumbs = ps.append('a')
      .attr('class', 'pull-right')
      .attr('href', '#')
      .append('svg')
      .attr('class', 'media-object')
      .attr('width', 128)
      .attr('height', 128);

    thumbs.append('use')
      .attr('xlink:href', '#basegeo');

    thumbs.append('path')
      .attr('id', function(d) { return 'thumb_' + d.properties.id })
      .attr('class', 'dataset active')
      .attr('d', smallPath); 

    //thumbs.attr('viewBox', '0 0 800 700');
    //thumbs.attr('preserveAspectRatio', 'xMidYMid slice');

    var body = ps.append('div')
      .attr('class', 'media-body');

    body
      .append('h4')
      .attr('class', 'media-heading')
      .text(function(d) { return d.properties.name || d.properties.id; });

    body
      .append('p')
      .text(function(d) { return d.properties.description || ""; });

    ps.on('mouseout', function(d) {
      d3.selectAll('#map path.dataset').classed({'active':false});
      d3.select(this).classed({'list-group-item-info': false});
    });

    ps.on('mouseover', function(d) {
      var sel = $('#map #' + d.properties.id);
      d3.selectAll(sel).classed({'active':true});

      d3.select(this).classed({'list-group-item-info': true});
    });

    ps.on('click', function(d) {
      toggleInfo(d.properties.id);
    });
}

$(function() {
  $('select').val('SECOORA', true).trigger('change');

});

</script>

{% endblock %}


